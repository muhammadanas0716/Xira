<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fira</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            overflow: hidden;
        }

        .sidebar-item {
            transition: all 0.2s ease;
        }

        .sidebar-item:hover {
            transform: translateX(2px);
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .pulse-slow {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .pdf-container {
            height: calc(100vh - 200px);
            overflow-y: auto;
            overflow-x: hidden;
            background: #f5f5f5;
        }

        .pdf-page {
            margin: 10px auto;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            background: white;
            display: block;
        }

        .hidden {
            display: none !important;
        }

        #pdfViewer {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100%;
        }

        #pdfViewer.hidden {
            display: none !important;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #000000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .btn-primary {
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .input-focus:focus {
            transform: scale(1.01);
            transition: transform 0.2s ease;
        }

        .history-item {
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: translateX(4px);
        }

        .table-row {
            transition: background-color 0.15s ease;
        }

        .table-row:hover {
            background-color: #f9fafb;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .resize-handle {
            width: 4px;
            height: 100%;
            background: #e5e7eb;
            cursor: col-resize;
            transition: background 0.2s ease;
            position: relative;
            flex-shrink: 0;
        }

        .resize-handle:hover {
            background: #000000;
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 40px;
            background: #9ca3af;
            border-radius: 2px;
        }

        .resize-handle:hover::before {
            background: #000000;
        }

        .resizing {
            user-select: none;
        }

        body.resizing {
            cursor: col-resize;
        }

        .sidebar-collapsed {
            width: 0 !important;
            overflow: hidden;
            border: none;
        }

        .sidebar-toggle {
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background-color: #f3f4f6;
        }

        .sidebar-reopen-btn {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 50;
            background: white;
            border: 1px solid #e5e7eb;
            border-left: none;
            border-radius: 0 12px 12px 0;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
        }

        .sidebar-reopen-btn:hover {
            background: #f9fafb;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
        }

        .sidebar-reopen-btn.hidden {
            display: none;
        }

        .markdown-content {
            line-height: 1.7;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4 {
            font-weight: 700;
            margin-top: 1.5em;
            margin-bottom: 0.75em;
            color: #111827;
        }

        .markdown-content h1 {
            font-size: 1.875rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5em;
        }

        .markdown-content h2 {
            font-size: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5em;
        }

        .markdown-content h3 {
            font-size: 1.25rem;
        }

        .markdown-content h4 {
            font-size: 1.125rem;
        }

        .markdown-content p {
            margin-bottom: 1em;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-left: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-content li {
            margin-bottom: 0.5em;
        }

        .markdown-content ul {
            list-style-type: disc;
        }

        .markdown-content ol {
            list-style-type: decimal;
        }

        .markdown-content strong {
            font-weight: 600;
            color: #111827;
        }

        .markdown-content em {
            font-style: italic;
        }

        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875em;
        }

        .markdown-content pre {
            background-color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #000000;
            padding-left: 1rem;
            margin-left: 0;
            margin-bottom: 1em;
            color: #6b7280;
            font-style: italic;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: left;
        }

        .markdown-content th {
            background-color: #f9fafb;
            font-weight: 600;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 2em 0;
        }
    </style>
</head>

<body class="bg-gray-50">
    <div class="flex h-screen overflow-hidden">
        <aside id="sidebar"
            class="w-64 bg-white border-r border-gray-200 flex flex-col transition-all duration-300 overflow-hidden">
            <div class="p-6 fade-in flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Fira</h1>
                <button onclick="toggleSidebar()"
                    class="sidebar-toggle p-2 rounded-lg text-gray-400 hover:text-gray-600">
                    <svg id="sidebarToggleIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="px-4 mb-6 fade-in">
                <button onclick="openNewChatModal()"
                    class="w-full bg-black hover:bg-gray-800 text-white font-semibold py-3 px-4 rounded-xl flex items-center justify-center gap-2 transition-all btn-primary">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Start new chat
                </button>
            </div>

            <nav class="px-4 mb-6 space-y-1 fade-in">
                <a href="#"
                    class="sidebar-item flex items-center gap-3 py-2.5 px-3 text-gray-700 hover:text-gray-900 hover:bg-gray-50 rounded-xl transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4">
                        </path>
                    </svg>
                    <span class="font-medium">Companies House</span>
                </a>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 py-2.5 px-3 text-gray-700 hover:text-gray-900 hover:bg-gray-50 rounded-xl transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <span class="font-medium">Your Documents</span>
                </a>
                <a href="#"
                    class="sidebar-item flex items-center gap-3 py-2.5 px-3 text-gray-700 hover:text-gray-900 hover:bg-gray-50 rounded-xl transition-all">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                        </path>
                    </svg>
                    <span class="font-medium">Reports</span>
                </a>
            </nav>

            <div class="px-4 mb-6 fade-in flex-1 overflow-y-auto scrollbar-hide">
                <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">HISTORY</h2>
                <div id="chatHistory" class="space-y-1">
                    <div
                        class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl bg-gray-100 cursor-pointer border border-gray-300">
                        <svg class="w-4 h-4 text-gray-900" fill="currentColor" viewBox="0 0 20 20">
                            <path
                                d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-800 font-medium truncate">what is inorganic strategy...</span>
                    </div>
                    <div class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">financial analysis Q3</span>
                    </div>
                    <div class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">revenue breakdown</span>
                    </div>
                    <div class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">cash flow analysis</span>
                    </div>
                    <div class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">market share trends</span>
                    </div>
                    <div class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">competitor comparison</span>
                    </div>
                    <div class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">earnings forecast</span>
                    </div>
                    <div class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">risk assessment</span>
                    </div>
                    <div class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">balance sheet review</span>
                    </div>
                    <div class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">growth strategy analysis</span>
                    </div>
                </div>
            </div>

            <div class="px-4 pb-6 fade-in">
                <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-3 mb-4">
                    <span class="text-xs font-bold text-yellow-800">FIRA IS IN BETA</span>
                </div>
                <p class="text-xs text-gray-500 mb-3 leading-relaxed">Share feedback to help us improve response
                    accuracy</p>
                <button
                    class="w-full text-xs text-gray-600 hover:text-gray-900 py-2.5 px-3 rounded-xl hover:bg-gray-50 transition-all font-medium">
                    Report a problem
                </button>
            </div>
        </aside>

        <button onclick="toggleSidebar()" id="sidebarReopenBtn" class="sidebar-reopen-btn hidden">
            <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16">
                </path>
            </svg>
        </button>

        <main class="flex-1 flex flex-col overflow-hidden">
            <div class="flex-1 overflow-y-auto p-8 scrollbar-hide">
                <div class="max-w-4xl mx-auto fade-in">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">Ventient Energy Limited</h2>
                        <p class="text-gray-600 text-lg">what is inorganic strategy of VEL?</p>
                    </div>

                    <div class="mb-8">
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-4">SOURCES ANALYZED</h3>
                        <div class="space-y-2">
                            <a href="#"
                                class="flex items-center gap-2 text-gray-900 hover:text-black text-sm font-medium transition-colors group">
                                <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                Annual report and financial statements
                            </a>
                            <a href="#"
                                class="flex items-center gap-2 text-gray-900 hover:text-black text-sm font-medium transition-colors group">
                                <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                Annual report and financial statements
                            </a>
                            <a href="#"
                                class="flex items-center gap-2 text-gray-900 hover:text-black text-sm font-medium transition-colors group">
                                <svg class="w-4 h-4 group-hover:scale-110 transition-transform" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                Annual report and financial statements
                            </a>
                        </div>
                    </div>

                    <div class="prose max-w-none mb-8">
                        <p class="text-gray-700 leading-relaxed mb-6 text-base">
                            VEL's inorganic strategy is focused on expanding the business through acquisitions.
                            Specifically, the company considers expansion through acquisition as one of the options to
                            grow its operating base alongside its organic initiatives such as life extension and
                            repowering of existing assets <sup
                                class="text-gray-900 font-semibold cursor-pointer hover:text-black">1</sup> <sup
                                class="text-gray-900 font-semibold cursor-pointer hover:text-black">2</sup>.
                        </p>

                        <h4 class="text-xl font-bold text-gray-900 mb-5">present in the table the main opex lines with
                            values for the past three years</h4>

                        <div class="overflow-x-auto mb-6 rounded-xl border border-gray-200 shadow-sm">
                            <table class="min-w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th
                                            class="px-6 py-4 text-left text-sm font-bold text-gray-700 border-b border-gray-200">
                                            Operating Expense Line</th>
                                        <th
                                            class="px-6 py-4 text-right text-sm font-bold text-gray-700 border-b border-gray-200">
                                            FY2021 (£000)</th>
                                        <th
                                            class="px-6 py-4 text-right text-sm font-bold text-gray-700 border-b border-gray-200">
                                            FY2022 (£000)</th>
                                        <th
                                            class="px-6 py-4 text-right text-sm font-bold text-gray-700 border-b border-gray-200">
                                            FY2023 (£000)</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white">
                                    <tr class="table-row border-b border-gray-100">
                                        <td class="px-6 py-4 text-sm text-gray-700 font-medium">Depreciation of
                                            property, plant and equipment</td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">28,533 <sup
                                                class="text-gray-900">1</sup></td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">32,145 <sup
                                                class="text-gray-900">1</sup></td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">35,892 <sup
                                                class="text-gray-900">1</sup></td>
                                    </tr>
                                    <tr class="table-row border-b border-gray-100">
                                        <td class="px-6 py-4 text-sm text-gray-700 font-medium">Amortisation of
                                            intangible fixed assets</td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">1,234 <sup
                                                class="text-gray-900">1</sup></td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">1,456 <sup
                                                class="text-gray-900">1</sup></td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">1,678 <sup
                                                class="text-gray-900">1</sup></td>
                                    </tr>
                                    <tr class="table-row border-b border-gray-100">
                                        <td class="px-6 py-4 text-sm text-gray-700 font-medium">Payments to landlords
                                            for royalties</td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">5,678 <sup
                                                class="text-gray-900">2</sup></td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">6,123 <sup
                                                class="text-gray-900">2</sup></td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">6,789 <sup
                                                class="text-gray-900">2</sup></td>
                                    </tr>
                                    <tr class="table-row">
                                        <td class="px-6 py-4 text-sm text-gray-700 font-medium">Audit of financial
                                            statements</td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">450 <sup
                                                class="text-gray-900">1</sup></td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">475 <sup
                                                class="text-gray-900">1</sup></td>
                                        <td class="px-6 py-4 text-sm text-gray-900 text-right font-medium">500 <sup
                                                class="text-gray-900">1</sup></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <p class="text-gray-600 text-sm leading-relaxed">
                            This table presents the key operating expense lines as disclosed in the financial statements
                            over the last three reporting years.
                        </p>
                    </div>
                </div>
            </div>

            <div class="border-t border-gray-200 p-4 bg-white shadow-lg">
                <div class="max-w-4xl mx-auto relative">
                    <input type="text" placeholder="Search or ask any question..."
                        class="w-full pl-12 pr-16 py-3.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent input-focus shadow-sm">
                    <svg class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2" fill="none"
                        stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <button onclick="askQuestion()"
                        class="absolute right-3 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-black hover:bg-gray-800 text-white rounded-xl flex items-center justify-center transition-all btn-primary shadow-md">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </main>

        <div class="resize-handle" id="resizeHandle"></div>
        <aside class="bg-white border-l border-gray-200 flex flex-col shadow-lg slide-in" id="pdfSidebar"
            style="width: 50%; min-width: 300px; max-width: 80%;">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between bg-gray-50">
                <h3 class="font-bold text-gray-900 text-lg">PDF Viewer</h3>
                <button onclick="closePdfViewer()"
                    class="text-gray-400 hover:text-gray-600 transition-colors p-1 rounded-lg hover:bg-gray-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-4 border-b border-gray-200 bg-gray-50">
                <div class="flex gap-2">
                    <input type="text" id="tickerInput" placeholder="Enter ticker (e.g., AAPL, TSLA)"
                        class="flex-1 px-4 py-2.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-900 focus:border-transparent input-focus shadow-sm"
                        onkeypress="handleTickerKeyPress(event)">
                    <button onclick="searchTicker()" id="searchBtn"
                        class="px-6 py-2.5 bg-black hover:bg-gray-800 text-white font-semibold rounded-xl transition-all btn-primary shadow-md">
                        Search
                    </button>
                </div>
                <div id="errorMessage" class="mt-2 text-sm text-red-600 hidden"></div>
                <div id="successMessage" class="mt-2 text-sm text-green-600 hidden"></div>
            </div>

            <div class="flex-1 overflow-hidden flex flex-col">
                <div id="pdfControls"
                    class="p-3 border-b border-gray-200 bg-gray-50 flex items-center justify-end hidden">
                    <div class="flex items-center gap-2">
                        <button onclick="zoomOut()"
                            class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium">
                            −
                        </button>
                        <span id="zoomLevel" class="text-sm text-gray-700 font-medium w-12 text-center">100%</span>
                        <button onclick="zoomIn()"
                            class="px-3 py-1.5 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-sm font-medium">
                            +
                        </button>
                    </div>
                </div>

                <div class="pdf-container" id="pdfContainer">
                    <div id="pdfPlaceholder" class="h-full flex items-center justify-center text-gray-400">
                        <div class="text-center">
                            <svg class="w-20 h-20 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                </path>
                            </svg>
                            <p class="text-sm font-medium">Search for a ticker to load PDF</p>
                        </div>
                    </div>
                    <div id="pdfLoading" class="hidden h-full flex items-center justify-center">
                        <div class="text-center">
                            <div class="loading-spinner mx-auto mb-4"></div>
                            <p class="text-sm text-gray-600 font-medium">Loading PDF...</p>
                        </div>
                    </div>
                    <div id="pdfViewer" class="hidden" style="display: none;"></div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        marked.setOptions({
            breaks: false,
            gfm: true,
            headerIds: false,
            mangle: false
        });

        function renderMarkdown(text) {
            if (!text) return '';
            try {
                return marked.parse(text);
            } catch (e) {
                console.error('Markdown parsing error:', e);
                return text.replace(/\n/g, '<br>');
            }
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        let pdfDoc = null;
        let scale = 1.2;
        const scaleDelta = 0.2;

        async function renderAllPages() {
            if (!pdfDoc) return;

            const container = document.getElementById('pdfViewer');
            container.innerHTML = '';

            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                try {
                    const page = await pdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: scale });
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const renderContext = {
                        canvasContext: ctx,
                        viewport: viewport
                    };

                    await page.render(renderContext).promise;

                    canvas.className = 'pdf-page';
                    container.appendChild(canvas);
                } catch (error) {
                    console.error(`Error rendering page ${pageNum}:`, error);
                }
            }
        }

        function zoomIn() {
            const newScale = Math.min(5.0, scale + scaleDelta);
            if (newScale !== scale) {
                scale = newScale;
                renderAllPages();
                updateZoomDisplay();
            }
        }

        function zoomOut() {
            const newScale = Math.max(0.25, scale - scaleDelta);
            if (newScale !== scale) {
                scale = newScale;
                renderAllPages();
                updateZoomDisplay();
            }
        }

        function updateZoomDisplay() {
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
        }


        async function loadPdfFromUrl(url) {
            console.log('Loading PDF from URL:', url);
            const pdfPlaceholder = document.getElementById('pdfPlaceholder');
            const pdfLoading = document.getElementById('pdfLoading');
            const pdfViewer = document.getElementById('pdfViewer');
            const pdfControls = document.getElementById('pdfControls');
            const pdfContainer = document.getElementById('pdfContainer');

            pdfPlaceholder.classList.add('hidden');
            pdfLoading.classList.remove('hidden');
            pdfViewer.classList.add('hidden');
            pdfControls.classList.add('hidden');
            pdfViewer.style.display = 'none';
            pdfViewer.innerHTML = '';

            try {
                console.log('Fetching PDF as blob...');
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) {
                        console.warn('PDF file not found:', url);
                        pdfLoading.classList.add('hidden');
                        pdfPlaceholder.classList.remove('hidden');
                        showError('PDF file not found. The file may not have been downloaded yet.');
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                console.log('PDF fetched, converting to array buffer...');
                const arrayBuffer = await response.arrayBuffer();
                console.log('Array buffer size:', arrayBuffer.byteLength);

                if (arrayBuffer.byteLength === 0) {
                    throw new Error('PDF file is empty');
                }

                const loadingTask = pdfjsLib.getDocument({ data: arrayBuffer });
                const pdf = await loadingTask.promise;

                console.log('PDF loaded, pages:', pdf.numPages);
                pdfDoc = pdf;
                scale = 1.2;
                updateZoomDisplay();

                await renderAllPages();

                console.log('All pages rendered');

                pdfLoading.classList.add('hidden');
                pdfPlaceholder.classList.add('hidden');
                pdfViewer.classList.remove('hidden');
                pdfViewer.style.display = 'flex';
                pdfControls.classList.remove('hidden');

                pdfContainer.scrollTop = 0;

                console.log('PDF viewer visible:', !pdfViewer.classList.contains('hidden'));
                console.log('PDF viewer children:', pdfViewer.children.length);
                console.log('PDF viewer style display:', pdfViewer.style.display);
            } catch (error) {
                console.error('Error loading PDF:', error);
                pdfLoading.classList.add('hidden');
                pdfViewer.classList.add('hidden');
                pdfViewer.style.display = 'none';
                pdfPlaceholder.classList.remove('hidden');
                showError('Failed to load PDF: ' + error.message);
            }
        }

        async function searchTicker() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) {
                showError('Please enter a ticker symbol');
                return;
            }

            hideMessages();
            const searchBtn = document.getElementById('searchBtn');
            searchBtn.disabled = true;
            searchBtn.textContent = 'Loading...';

            try {
                showError('PDF viewing is not available.');
            } catch (error) {
                console.error('Error:', error);
                showError('An error occurred. Please try again.');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search';
            }
        }

        function handleTickerKeyPress(event) {
            if (event.key === 'Enter') {
                searchTicker();
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('successMessage').classList.add('hidden');
        }

        function closePdfViewer() {
            document.getElementById('tickerInput').value = '';
            const pdfViewer = document.getElementById('pdfViewer');
            pdfViewer.classList.add('hidden');
            pdfViewer.style.display = 'none';
            document.getElementById('pdfControls').classList.add('hidden');
            document.getElementById('pdfLoading').classList.add('hidden');
            document.getElementById('pdfPlaceholder').classList.remove('hidden');
            pdfDoc = null;
            hideMessages();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const icon = document.getElementById('sidebarToggleIcon');
            const reopenBtn = document.getElementById('sidebarReopenBtn');
            sidebar.classList.toggle('sidebar-collapsed');

            if (sidebar.classList.contains('sidebar-collapsed')) {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>';
                reopenBtn.classList.remove('hidden');
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>';
                reopenBtn.classList.add('hidden');
            }
        }

        (function () {
            const resizeHandle = document.getElementById('resizeHandle');
            const pdfSidebar = document.getElementById('pdfSidebar');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizeHandle.addEventListener('mousedown', function (e) {
                isResizing = true;
                startX = e.clientX;
                const computedWidth = window.getComputedStyle(pdfSidebar).width;
                startWidth = parseFloat(computedWidth) || window.innerWidth * 0.5;
                document.body.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function (e) {
                if (!isResizing) return;

                const deltaX = e.clientX - startX;
                const newWidthPx = startWidth - deltaX;
                const newWidthPercent = (newWidthPx / window.innerWidth) * 100;
                const minWidthPercent = (300 / window.innerWidth) * 100;
                const maxWidthPercent = 80;

                if (newWidthPercent >= minWidthPercent && newWidthPercent <= maxWidthPercent) {
                    pdfSidebar.style.width = newWidthPercent + '%';
                }
            });

            document.addEventListener('mouseup', function () {
                if (isResizing) {
                    isResizing = false;
                    document.body.classList.remove('resizing');
                    document.body.style.cursor = '';
                }
            });
        })();

        {% if pdfs %}
        window.addEventListener('load', function () {
            const firstPdf = '{{ pdfs[0] }}';
            if (firstPdf) {
                document.getElementById('tickerInput').value = firstPdf.replace('_latest_10Q.pdf', '');
                loadPdfFromUrl(`/pdfs/${firstPdf}`);
            }
        });
        {% endif %}

        let currentChatId = null;

        function openNewChatModal() {
            document.getElementById('newChatModal').classList.remove('hidden');
            document.getElementById('newChatTickerInput').focus();
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').classList.add('hidden');
            document.getElementById('newChatTickerInput').value = '';
        }

        async function createNewChat() {
            const ticker = document.getElementById('newChatTickerInput').value.trim().toUpperCase();
            if (!ticker) {
                alert('Please enter a ticker symbol');
                return;
            }

            const modal = document.getElementById('newChatModal');
            const loadingDiv = modal.querySelector('.loading-indicator');
            loadingDiv.classList.remove('hidden');

            try {
                const response = await fetch('/api/create-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ticker: ticker })
                });

                const data = await response.json();
                if (response.ok) {
                    currentChatId = data.chat_id;
                    console.log('Chat created:', data);
                    console.log('PDF text length:', data.pdf_text_length);
                    if (!data.has_pdf || data.pdf_text_length === 0) {
                        alert(`Warning: PDF text extraction may have failed. PDF text length: ${data.pdf_text_length || 0} characters. You may not be able to ask questions about the PDF.`);
                    }
                    loadChat(data.chat_id);
                    closeNewChatModal();
                    loadChatHistory();
                    if (data.pdf_filename) {
                        setTimeout(() => {
                            loadPdfFromUrl(`/pdfs/${data.pdf_filename}`);
                        }, 500);
                    }
                } else {
                    alert(data.error || 'Failed to create chat');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            } finally {
                loadingDiv.classList.add('hidden');
            }
        }

        async function loadChat(chatId) {
            try {
                const response = await fetch(`/api/chats/${chatId}`);
                const chat = await response.json();

                if (response.ok) {
                    currentChatId = chatId;
                    console.log('Chat loaded:', chat);
                    console.log('PDF text length:', chat.pdf_text_length || 0);
                    if (chat.pdf_text_preview) {
                        console.log('PDF text preview:', chat.pdf_text_preview);
                    }
                    displayChat(chat);
                    if (chat.pdf_filename) {
                        setTimeout(() => {
                            loadPdfFromUrl(`/pdfs/${chat.pdf_filename}`);
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        function displayChat(chat) {
            const mainContent = document.querySelector('main .flex-1.overflow-y-auto');
            const stockInfo = chat.stock_info;
            const hasReport = chat.has_report || chat.messages.some(msg => msg.question === "Generate comprehensive report");

            let html = `
                <div class="max-w-4xl mx-auto fade-in">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-gray-900 mb-2">${stockInfo.name} (${stockInfo.ticker})</h2>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Current Price</div>
                                <div class="text-xl font-bold text-gray-900">$${stockInfo.currentPrice?.toFixed(2) || 'N/A'}</div>
                                ${stockInfo.prevClose ? `<div class="text-xs mt-1 ${stockInfo.currentPrice > stockInfo.prevClose ? 'text-green-600' : stockInfo.currentPrice < stockInfo.prevClose ? 'text-red-600' : 'text-gray-500'}">${stockInfo.currentPrice > stockInfo.prevClose ? '↑' : stockInfo.currentPrice < stockInfo.prevClose ? '↓' : '→'} ${Math.abs(((stockInfo.currentPrice - stockInfo.prevClose) / stockInfo.prevClose) * 100).toFixed(2)}%</div>` : ''}
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">P/E Ratio</div>
                                <div class="text-xl font-bold text-gray-900">${stockInfo.peRatio?.toFixed(2) || 'N/A'}</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Market Cap</div>
                                <div class="text-xl font-bold text-gray-900">${stockInfo.marketCap ? (stockInfo.marketCap >= 1e12 ? (stockInfo.marketCap / 1e12).toFixed(2) + 'T' : (stockInfo.marketCap / 1e9).toFixed(2) + 'B') : 'N/A'}</div>
                            </div>
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Sector</div>
                                <div class="text-lg font-semibold text-gray-900">${stockInfo.sector || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mt-4">
                            ${stockInfo.open ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Open</div>
                                <div class="text-lg font-bold text-gray-900">$${stockInfo.open.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.high ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">High</div>
                                <div class="text-lg font-bold text-green-600">$${stockInfo.high.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.low ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Low</div>
                                <div class="text-lg font-bold text-red-600">$${stockInfo.low.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.volume ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Volume</div>
                                <div class="text-lg font-bold text-gray-900">${stockInfo.volume >= 1e9 ? (stockInfo.volume / 1e9).toFixed(2) + 'B' : stockInfo.volume >= 1e6 ? (stockInfo.volume / 1e6).toFixed(2) + 'M' : stockInfo.volume.toLocaleString()}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.eps ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">EPS</div>
                                <div class="text-lg font-bold text-gray-900">$${stockInfo.eps.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.beta ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Beta</div>
                                <div class="text-lg font-bold text-gray-900">${stockInfo.beta.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.dividendYield ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Dividend Yield</div>
                                <div class="text-lg font-bold text-gray-900">${(stockInfo.dividendYield * 100).toFixed(2)}%</div>
                            </div>
                            ` : ''}
                            ${stockInfo.profitMargin ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Profit Margin</div>
                                <div class="text-lg font-bold text-gray-900">${(stockInfo.profitMargin * 100).toFixed(2)}%</div>
                            </div>
                            ` : ''}
                            ${stockInfo.roe ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">ROE</div>
                                <div class="text-lg font-bold text-gray-900">${(stockInfo.roe * 100).toFixed(2)}%</div>
                            </div>
                            ` : ''}
                            ${stockInfo.roa ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">ROA</div>
                                <div class="text-lg font-bold text-gray-900">${(stockInfo.roa * 100).toFixed(2)}%</div>
                            </div>
                            ` : ''}
                            ${stockInfo.priceToBook ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">P/B Ratio</div>
                                <div class="text-lg font-bold text-gray-900">${stockInfo.priceToBook.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.priceToSales ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">P/S Ratio</div>
                                <div class="text-lg font-bold text-gray-900">${stockInfo.priceToSales.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.debtToEquity ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Debt/Equity</div>
                                <div class="text-lg font-bold text-gray-900">${stockInfo.debtToEquity.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.currentRatio ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Current Ratio</div>
                                <div class="text-lg font-bold text-gray-900">${stockInfo.currentRatio.toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo['52WeekHigh'] ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">52W High</div>
                                <div class="text-lg font-bold text-green-600">$${stockInfo['52WeekHigh'].toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo['52WeekLow'] ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">52W Low</div>
                                <div class="text-lg font-bold text-red-600">$${stockInfo['52WeekLow'].toFixed(2)}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.revenue ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Revenue</div>
                                <div class="text-lg font-bold text-gray-900">${stockInfo.revenue >= 1e12 ? (stockInfo.revenue / 1e12).toFixed(2) + 'T' : (stockInfo.revenue / 1e9).toFixed(2) + 'B'}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.enterpriseValue ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Enterprise Value</div>
                                <div class="text-lg font-bold text-gray-900">${stockInfo.enterpriseValue >= 1e12 ? (stockInfo.enterpriseValue / 1e12).toFixed(2) + 'T' : (stockInfo.enterpriseValue / 1e9).toFixed(2) + 'B'}</div>
                            </div>
                            ` : ''}
                            ${stockInfo.sharesOutstanding ? `
                            <div class="bg-white p-4 rounded-xl border border-gray-200">
                                <div class="text-xs text-gray-500 mb-1">Shares Outstanding</div>
                                <div class="text-lg font-bold text-gray-900">${stockInfo.sharesOutstanding >= 1e9 ? (stockInfo.sharesOutstanding / 1e9).toFixed(2) + 'B' : (stockInfo.sharesOutstanding / 1e6).toFixed(2) + 'M'}</div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="mt-6 flex gap-3">
                            <button onclick="generateReport()" id="generateReportBtn"
                                class="bg-black hover:bg-gray-800 text-white font-semibold py-2.5 px-6 rounded-xl transition-all btn-primary shadow-md flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Generate Report
                            </button>
                            <button onclick="exportReportToPDF()" id="exportReportBtn" class="${hasReport ? '' : 'hidden'} bg-black hover:bg-gray-800 text-white font-semibold py-2.5 px-6 rounded-xl transition-all btn-primary shadow-md flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Export as PDF
                            </button>
                        </div>
                    </div>
                    <div id="chatMessages" class="space-y-6">
            `;

            chat.messages.forEach(msg => {
                const isReport = msg.question === "Generate comprehensive report";
                html += `
                    <div class="bg-white rounded-xl p-6 border border-gray-200 ${isReport ? 'report-container' : ''}">
                        <div class="mb-3">
                            ${!isReport ? `<div class="text-sm font-semibold text-gray-900 mb-2">Q: ${msg.question}</div>` : ''}
                            <div class="text-gray-700 leading-relaxed markdown-content ${isReport ? 'report-content' : ''}" ${isReport ? 'id="generatedReport"' : ''}>${renderMarkdown(msg.answer)}</div>
                        </div>
                    </div>
                `;
            });

            html += `</div></div>`;
            mainContent.innerHTML = html;
        }

        async function askQuestion() {
            if (!currentChatId) {
                alert('Please create a chat first');
                return;
            }

            const input = document.querySelector('input[placeholder="Search or ask any question..."]');
            const question = input.value.trim();
            if (!question) return;

            input.value = '';
            const messagesDiv = document.getElementById('chatMessages');

            messagesDiv.innerHTML += `
                <div class="bg-white rounded-xl p-6 border border-gray-200">
                    <div class="text-sm font-semibold text-gray-900 mb-2">Q: ${question}</div>
                    <div class="text-gray-700 leading-relaxed markdown-content">Thinking...</div>
                </div>
            `;

            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                console.log('Asking question:', question);
                const response = await fetch(`/api/chats/${currentChatId}/ask`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question })
                });

                const data = await response.json();
                console.log('Response:', data);

                const lastMsg = messagesDiv.lastElementChild;
                if (response.ok) {
                    if (data.answer) {
                        lastMsg.innerHTML = `
                            <div class="text-sm font-semibold text-gray-900 mb-2">Q: ${data.question}</div>
                            <div class="text-gray-700 leading-relaxed markdown-content">${renderMarkdown(data.answer)}</div>
                        `;
                    } else {
                        lastMsg.innerHTML = `
                            <div class="text-sm font-semibold text-gray-900 mb-2">Q: ${data.question}</div>
                            <div class="text-yellow-600">No answer received from LLM. Check server logs.</div>
                        `;
                    }
                } else {
                    lastMsg.innerHTML = `
                        <div class="text-sm font-semibold text-gray-900 mb-2">Q: ${question}</div>
                        <div class="text-red-600">Error: ${data.error || 'Unknown error'}</div>
                        <div class="text-xs text-gray-500 mt-2">Check browser console and server logs for details.</div>
                    `;
                }
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Error asking question:', error);
                const lastMsg = messagesDiv.lastElementChild;
                lastMsg.innerHTML = `
                    <div class="text-sm font-semibold text-gray-900 mb-2">Q: ${question}</div>
                    <div class="text-red-600">Network error: ${error.message}</div>
                    <div class="text-xs text-gray-500 mt-2">Check browser console for details.</div>
                `;
            }
        }


        async function loadChatHistory() {
            try {
                const response = await fetch('/api/chats');
                const chats = await response.json();
                const historyDiv = document.getElementById('chatHistory');

                historyDiv.innerHTML = chats.map(chat => `
                    <div onclick="loadChat('${chat.id}')" class="history-item flex items-center gap-2 py-2.5 px-3 rounded-xl cursor-pointer">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <span class="text-sm text-gray-700 truncate">${chat.ticker}</span>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        async function generateReport() {
            if (!currentChatId) {
                alert('Please create a chat first');
                return;
            }

            const btn = document.getElementById('generateReportBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner mx-auto" style="width: 20px; height: 20px;"></div> Generating...';

            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML += `
                <div class="bg-white rounded-xl p-6 border border-gray-200">
                    <div class="text-gray-700 leading-relaxed markdown-content">Generating comprehensive report... This may take a moment.</div>
                </div>
            `;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                const response = await fetch(`/api/chats/${currentChatId}/generate-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const data = await response.json();

                if (response.ok) {
                    const lastMsg = messagesDiv.lastElementChild;
                    lastMsg.innerHTML = `
                        <div class="mb-3">
                            <div class="text-gray-700 leading-relaxed markdown-content report-content" id="generatedReport">${renderMarkdown(data.report)}</div>
                        </div>
                    `;
                    lastMsg.classList.add('report-container');
                    document.getElementById('exportReportBtn').classList.remove('hidden');
                    await loadChat(currentChatId);
                } else {
                    const lastMsg = messagesDiv.lastElementChild;
                    lastMsg.innerHTML = `
                        <div class="text-red-600">Error: ${data.error || 'Failed to generate report'}</div>
                    `;
                }
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Error generating report:', error);
                const lastMsg = messagesDiv.lastElementChild;
                lastMsg.innerHTML = `
                    <div class="text-red-600">Network error: ${error.message}</div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function exportReportToPDF() {
            const reportElement = document.getElementById('generatedReport');
            if (!reportElement) {
                alert('No report found to export');
                return;
            }

            const chat = await fetch(`/api/chats/${currentChatId}`).then(r => r.json());
            const ticker = chat.ticker;
            const stockName = chat.stock_info.name;

            const opt = {
                margin: [15, 15, 15, 15],
                filename: `${ticker}_Quarterly_Report_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.85 },
                html2canvas: {
                    scale: 1,
                    useCORS: true,
                    letterRendering: false,
                    logging: false,
                    windowWidth: 800,
                    allowTaint: false
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            const reportContainer = document.createElement('div');
            reportContainer.style.cssText = `
                padding: 50px 60px;
                font-family: 'Georgia', 'Times New Roman', serif;
                width: 800px;
                margin: 0 auto;
                background-color: white;
                color: #1f2937;
                line-height: 1.7;
                font-size: 11pt;
                overflow: hidden;
            `;

            let reportContent = reportElement.innerHTML;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = reportContent;

            const styleElement = (element, styles) => {
                if (!element.style.cssText) {
                    element.style.cssText = styles;
                }
            };

            const elements = tempDiv.querySelectorAll('*');
            elements.forEach(el => {
                const tagName = el.tagName.toLowerCase();

                switch (tagName) {
                    case 'h1':
                        styleElement(el, 'font-size: 24pt; font-weight: bold; margin-top: 30px; margin-bottom: 15px; color: #111827; border-bottom: 3px solid #000000; padding-bottom: 10px; page-break-after: avoid;');
                        break;
                    case 'h2':
                        styleElement(el, 'font-size: 18pt; font-weight: bold; margin-top: 25px; margin-bottom: 12px; color: #111827; border-bottom: 2px solid #000000; padding-bottom: 8px; page-break-after: avoid;');
                        break;
                    case 'h3':
                        styleElement(el, 'font-size: 14pt; font-weight: bold; margin-top: 20px; margin-bottom: 10px; color: #111827; page-break-after: avoid;');
                        break;
                    case 'h4':
                        styleElement(el, 'font-size: 12pt; font-weight: bold; margin-top: 15px; margin-bottom: 8px; color: #111827; page-break-after: avoid;');
                        break;
                    case 'h5':
                        styleElement(el, 'font-size: 11pt; font-weight: bold; margin-top: 12px; margin-bottom: 6px; color: #111827; page-break-after: avoid;');
                        break;
                    case 'h6':
                        styleElement(el, 'font-size: 10pt; font-weight: bold; margin-top: 10px; margin-bottom: 5px; color: #111827; page-break-after: avoid;');
                        break;
                    case 'p':
                        styleElement(el, 'margin-bottom: 15px; text-align: justify; line-height: 1.8;');
                        break;
                    case 'ul':
                        styleElement(el, 'margin-left: 25px; margin-bottom: 18px; margin-top: 12px; padding-left: 20px; list-style-type: disc;');
                        break;
                    case 'ol':
                        styleElement(el, 'margin-left: 25px; margin-bottom: 18px; margin-top: 12px; padding-left: 20px; list-style-type: decimal;');
                        break;
                    case 'li':
                        styleElement(el, 'margin-bottom: 10px; line-height: 1.7;');
                        break;
                    case 'table':
                        styleElement(el, 'width: 100%; border-collapse: collapse; margin: 25px 0; page-break-inside: avoid; border: 2px solid #d1d5db; background-color: white;');
                        break;
                    case 'th':
                        styleElement(el, 'background-color: #f3f4f6 !important; border: 1px solid #9ca3af; padding: 14px 12px; text-align: left; font-weight: bold; color: #111827; font-size: 10pt;');
                        break;
                    case 'td':
                        styleElement(el, 'border: 1px solid #d1d5db; padding: 12px; text-align: left; font-size: 10pt; line-height: 1.6;');
                        break;
                    case 'tr':
                        styleElement(el, 'page-break-inside: avoid;');
                        break;
                    case 'strong':
                    case 'b':
                        styleElement(el, 'font-weight: bold; color: #111827;');
                        break;
                    case 'em':
                    case 'i':
                        styleElement(el, 'font-style: italic; color: #374151;');
                        break;
                    case 'hr':
                        styleElement(el, 'border: none; border-top: 2px solid #e5e7eb; margin: 30px 0;');
                        break;
                    case 'blockquote':
                        styleElement(el, 'border-left: 4px solid #000000; margin-left: 0; margin-bottom: 18px; color: #4b5563; font-style: italic; background-color: #f9fafb; padding: 15px 20px; border-radius: 4px;');
                        break;
                    case 'code':
                        if (el.parentElement.tagName.toLowerCase() !== 'pre') {
                            styleElement(el, 'background-color: #f3f4f6; padding: 2px 6px; border-radius: 3px; font-family: "Courier New", monospace; font-size: 9pt; color: #111827;');
                        }
                        break;
                    case 'pre':
                        styleElement(el, 'background-color: #f3f4f6; padding: 15px; border-radius: 4px; overflow-x: auto; margin: 15px 0; border: 1px solid #d1d5db;');
                        break;
                    case 'a':
                        styleElement(el, 'color: #000000; text-decoration: underline;');
                        break;
                }
            });

            reportContent = tempDiv.innerHTML;

            reportContainer.innerHTML = `
                <style>
                    * {
                        box-sizing: border-box;
                    }
                    h1, h2, h3, h4, h5, h6 {
                        page-break-after: avoid;
                        page-break-inside: avoid;
                        font-weight: bold !important;
                    }
                    h1 {
                        font-size: 24pt !important;
                        color: #111827 !important;
                        border-bottom: 3px solid #000000 !important;
                        padding-bottom: 10px !important;
                        margin-top: 30px !important;
                        margin-bottom: 15px !important;
                    }
                    h2 {
                        font-size: 18pt !important;
                        color: #111827 !important;
                        border-bottom: 2px solid #000000 !important;
                        padding-bottom: 8px !important;
                        margin-top: 25px !important;
                        margin-bottom: 12px !important;
                    }
                    h3 {
                        font-size: 14pt !important;
                        color: #111827 !important;
                        margin-top: 20px !important;
                        margin-bottom: 10px !important;
                    }
                    h4 {
                        font-size: 12pt !important;
                        color: #111827 !important;
                        margin-top: 15px !important;
                        margin-bottom: 8px !important;
                    }
                    h5 {
                        font-size: 11pt !important;
                        color: #111827 !important;
                        margin-top: 12px !important;
                        margin-bottom: 6px !important;
                    }
                    h6 {
                        font-size: 10pt !important;
                        color: #111827 !important;
                        margin-top: 10px !important;
                        margin-bottom: 5px !important;
                    }
                    p {
                        orphans: 3;
                        widows: 3;
                        page-break-inside: avoid;
                        margin-bottom: 15px !important;
                        text-align: justify !important;
                        line-height: 1.8 !important;
                    }
                    table {
                        page-break-inside: avoid;
                        border-spacing: 0;
                        width: 100% !important;
                        border-collapse: collapse !important;
                        margin: 25px 0 !important;
                        border: 2px solid #d1d5db !important;
                        background-color: white !important;
                    }
                    tr {
                        page-break-inside: avoid;
                    }
                    table th {
                        background-color: #f3f4f6 !important;
                        font-weight: bold !important;
                        border: 1px solid #9ca3af !important;
                        padding: 14px 12px !important;
                        text-align: left !important;
                        color: #111827 !important;
                        font-size: 10pt !important;
                    }
                    table td {
                        border: 1px solid #d1d5db !important;
                        padding: 12px !important;
                        text-align: left !important;
                        font-size: 10pt !important;
                        line-height: 1.6 !important;
                    }
                    table tr:nth-child(even) {
                        background-color: #fafafa !important;
                    }
                    ul, ol {
                        page-break-inside: avoid;
                        margin-left: 25px !important;
                        margin-bottom: 18px !important;
                        margin-top: 12px !important;
                        padding-left: 20px !important;
                    }
                    li {
                        margin-bottom: 10px !important;
                        line-height: 1.7 !important;
                    }
                    strong, b {
                        font-weight: bold !important;
                        color: #111827 !important;
                    }
                    em, i {
                        font-style: italic !important;
                        color: #374151 !important;
                    }
                    blockquote {
                        border-left: 4px solid #000000 !important;
                        margin-left: 0 !important;
                        margin-bottom: 18px !important;
                        color: #4b5563 !important;
                        font-style: italic !important;
                        background-color: #f9fafb !important;
                        padding: 15px 20px !important;
                        border-radius: 4px !important;
                    }
                    hr {
                        border: none !important;
                        border-top: 2px solid #e5e7eb !important;
                        margin: 30px 0 !important;
                    }
                    code {
                        background-color: #f3f4f6 !important;
                        padding: 2px 6px !important;
                        border-radius: 3px !important;
                        font-family: "Courier New", monospace !important;
                        font-size: 9pt !important;
                        color: #111827 !important;
                    }
                    pre {
                        background-color: #f3f4f6 !important;
                        padding: 15px !important;
                        border-radius: 4px !important;
                        overflow-x: auto !important;
                        margin: 15px 0 !important;
                        border: 1px solid #d1d5db !important;
                    }
                    pre code {
                        background-color: transparent !important;
                        padding: 0 !important;
                    }
                    a {
                        color: #000000 !important;
                        text-decoration: underline !important;
                    }
                </style>
                <div style="margin-bottom: 40px; border-bottom: 3px solid #000000; padding-bottom: 25px; page-break-after: avoid;">
                    <h1 style="font-size: 28pt; font-weight: bold; margin-bottom: 8px; color: #111827; border: none; padding: 0;">${stockName} (${ticker})</h1>
                    <p style="color: #6b7280; font-size: 12pt; margin: 0;">Quarterly Report Analysis - Generated ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <div style="line-height: 1.8;">
                    ${reportContent}
                </div>
            `;

            document.body.appendChild(reportContainer);

            await new Promise(resolve => setTimeout(resolve, 100));

            const containerHeight = reportContainer.scrollHeight;
            const maxCanvasSize = 16384;
            const estimatedCanvasHeight = containerHeight * opt.html2canvas.scale;

            if (estimatedCanvasHeight > maxCanvasSize) {
                opt.html2canvas.scale = Math.max(0.5, maxCanvasSize / containerHeight * 0.9);
                console.log(`Reducing scale to ${opt.html2canvas.scale} to fit canvas size limits`);
            }

            const exportBtn = document.getElementById('exportReportBtn');
            const originalBtnText = exportBtn.innerHTML;
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<div class="loading-spinner mx-auto" style="width: 16px; height: 16px; display: inline-block;"></div> Exporting...';

            try {
                const worker = html2pdf().set(opt).from(reportContainer);

                await new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('PDF export timed out. The report may be too large.'));
                    }, 120000);

                    worker.save().then(() => {
                        clearTimeout(timeout);
                        resolve();
                    }).catch((err) => {
                        clearTimeout(timeout);
                        reject(err);
                    });
                });
            } catch (error) {
                console.error('Error exporting PDF:', error);

                let errorMessage = 'Failed to export PDF. ';
                if (error.message && (error.message.includes('Canvas exceeds max size') || error.message.includes('exceeded'))) {
                    errorMessage += 'The report is too large. Try generating a shorter report or contact support.';
                } else if (error.message && error.message.includes('timed out')) {
                    errorMessage += 'Export timed out. The report may be too large.';
                } else {
                    errorMessage += 'Please try again.';
                }

                alert(errorMessage);
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalBtnText;
                if (document.body.contains(reportContainer)) {
                    document.body.removeChild(reportContainer);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadChatHistory();
            const searchInput = document.querySelector('input[placeholder="Search or ask any question..."]');
            if (searchInput) {
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        askQuestion();
                    }
                });
            }
        });
    </script>

    <div id="newChatModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">Start New Chat</h3>
                <button onclick="closeNewChatModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Enter Ticker Symbol</label>
                <input id="newChatTickerInput" type="text" placeholder="e.g., AAPL, TSLA, MSFT"
                    class="w-full px-4 py-2.5 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-900"
                    onkeypress="if(event.key==='Enter') createNewChat()">
            </div>
            <div class="loading-indicator hidden mb-4 text-center text-gray-600">
                Loading stock data and PDF...
            </div>
            <button onclick="createNewChat()"
                class="w-full bg-black hover:bg-gray-800 text-white font-semibold py-3 px-4 rounded-xl transition-all">
                Create Chat
            </button>
        </div>
    </div>
</body>

</html>